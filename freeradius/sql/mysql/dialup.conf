# FreeRADIUS MySQL Configuration for ISP Billing
# Copy to /etc/freeradius/3.0/mods-available/dialup.conf

sql {
    dialect = "mysql"

    # Connection info
    driver = "rlm_sql_${dialect}"
    server = "localhost"
    port = 3306
    login = "freeradius"
    password = "freeradius_secret"

    # Database name (RADIUS database)
    radius_db = "radius"

    # Table mappings
    acct_table1 = "radacct"
    acct_table2 = "radacct"
    auth_table = "radcheck"
    group_reply_table = "radgroupreply"
    group_check_table = "radgroupcheck"
    user_group_table = "radusergroup"
    reply_table = "radreply"
    nas_table = "nas"

    # Default profile
    default_profile = "NULL"

    # Query configurations
    # Authorization queries
    authorize_check_query = "SELECT id, username, attribute, value, op FROM radcheck WHERE username = '%{SQL-User-Name}' ORDER BY id"
    authorize_reply_query = "SELECT id, username, attribute, value, op FROM radreply WHERE username = '%{SQL-User-Name}' ORDER BY id"
    authorize_group_check_query = "SELECT id, groupname, attribute, value, op FROM radgroupcheck WHERE groupname = '%{SQL-Group}' ORDER BY id"
    authorize_group_reply_query = "SELECT id, groupname, attribute, value, op FROM radgroupreply WHERE groupname = '%{SQL-Group}' ORDER BY id"
    authorize_user_group_query = "SELECT groupname FROM radusergroup WHERE username = '%{SQL-User-Name}' ORDER BY priority"

    # Authentication queries
    authenticate_query = "SELECT id, username, attribute, value, op FROM radcheck WHERE username = '%{SQL-User-Name}'"

    # Accounting queries
    accounting_query = "SELECT RadAcctId, AcctSessionId, AcctUniqueId, Username, NASIPAddress, NASPortId, AcctStartTime, AcctStopTime, AcctSessionTime, AcctInputOctets, AcctOutputOctets FROM radacct WHERE AcctSessionId = '%{Acct-Session-Id}' AND Username = '%{SQL-User-Name}' AND NASIPAddress = '%{NAS-IP-Address}'"
    start_accounting_query = "INSERT INTO radacct (AcctSessionId, AcctUniqueId, Username, Realm, NASIPAddress, NASPortId, NASPortType, AcctStartTime, AcctStopTime, AcctSessionTime, AcctInputOctets, AcctOutputOctets, CalledStationId, CallingStationId, AcctTerminateCause, ServiceType, FramedProtocol, FramedIPAddress) VALUES ('%{Acct-Session-Id}', '%{Acct-Unique-Session-Id}', '%{SQL-User-Name}', '%{Realm}', '%{NAS-IP-Address}', '%{NAS-Port}', '%{NAS-Port-Type}', FROM_UNIXTIME(%{Acct-Start-Time}), NULL, 0, 0, 0, '%{Called-Station-Id}', '%{Calling-Station-Id}', '%{Acct-Terminate-Cause}', '%{Service-Type}', '%{Framed-Protocol}', '%{Framed-IP-Address}')"
    interim_update_query = "UPDATE radacct SET AcctInputOctets = '%{%{Acct-Input-Gigawords}:-0}' * 1073741824 + '%{%{Acct-Input-Octets}:-0}', AcctOutputOctets = '%{%{Acct-Output-Gigawords}:-0}' * 1073741824 + '%{%{Acct-Output-Octets}:-0}', AcctSessionTime = '%{Acct-Session-Time}', AcctStopTime = FROM_UNIXTIME(%{Acct-Stop-Time}) WHERE AcctSessionId = '%{Acct-Session-Id}' AND Username = '%{SQL-User-Name}' AND NASIPAddress = '%{NAS-IP-Address}'"
    stop_accounting_query = "UPDATE radacct SET AcctStopTime = FROM_UNIXTIME(%{Acct-Stop-Time}), AcctSessionTime = '%{Acct-Session-Time}', AcctInputOctets = '%{%{Acct-Input-Gigawords}:-0}' * 1073741824 + '%{%{Acct-Input-Octets}:-0}', AcctOutputOctets = '%{%{Acct-Output-Gigawords}:-0}' * 1073741824 + '%{%{Acct-Output-Octets}:-0}', AcctTerminateCause = '%{Acct-Terminate-Cause}', AcctDelayTime = '%{Acct-Delay-Time}' WHERE AcctSessionId = '%{Acct-Session-Id}' AND Username = '%{SQL-User-Name}' AND NASIPAddress = '%{NAS-IP-Address}'"

    # Session queries
    session_query = "SELECT RadAcctId, AcctSessionId, Username, NASIPAddress, NASPortId, FramedIPAddress, AcctStartTime FROM radacct WHERE AcctSessionId = '%{Acct-Session-Id}' AND Username = '%{SQL-User-Name}' AND NASIPAddress = '%{NAS-IP-Address}' AND AcctStopTime IS NULL"
    user_exists_check_query = "SELECT id FROM radcheck WHERE username = '%{SQL-User-Name}'"

    # Post-Auth queries
    postauth_query = "INSERT INTO radpostauth (username, pass, reply, authdate) VALUES ('%{SQL-User-Name}', '%{User-Password}', '%{reply:Packet-Type}', NOW())"

    # Simultaneous use settings
    simultaneous_use = "radutmp"
    check_simul = "yes"
    simul_verify_query = "SELECT RadAcctId, AcctSessionId, Username, NASIPAddress, NASPortId, FramedIPAddress, AcctStartTime FROM radacct WHERE Username = '%{SQL-User-Name}' AND AcctStopTime IS NULL"

    # Safe characters for SQL
    safe_characters = "@abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789.-_: /"

    # Read groups from reply
    read_groups = yes

    # Client configuration
    read_clients = yes
    client_table = "nas"

    # Delete sessions
    delete_stale_sessions = yes
    pool_start = ${thread[pool].start_servers}
    pool_stop = ${thread[pool].min_spare_servers}
    pool_max = ${thread[pool].max_servers}
    pool_idle_timeout = 60
    pool_connect_timeout = 3
}

# Include accounting and post-auth
$INCLUDE ${modconfdir}/sql/mysql/counter.conf
